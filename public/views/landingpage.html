<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>StudentHub - Buy & Sell Student Items</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
        
        <script src="../loadHeader.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

        <link rel="stylesheet" href="../style2landing.css">
    </head>

    <body>
    <!-- Header -->
        <div id="header"></div>

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h1>Buy & Sell Student Items</h1>
                <p>The ultimate marketplace for students to trade textbooks, supplies, electronics, and more with fellow students on campus.</p>
                <div class="hero-actions">
                    <a href="#" class="btn btn-primary">Start Shopping</a>
                    <a href="./sellItem.html" class="btn btn-outline">List Your Items</a>
                </div>
            </div>
        </section>

        <!-- SEARCH RESULTS SECTION (Dynamic) -->
    <section class="featured-products" id="searchResultsSection" style="display:none;">
        <div class="container">
        <div class="section-header">
            <h2 class="section-title">Search Results</h2>
            <p class="section-subtitle">Here's what we found for your search</p>
        </div>
        <div class="product-grid" id="searchResultsGrid"></div>
        
        <!-- Search Results Pagination -->
        <div class="pagination-container" id="searchPagination" style="display: none;">
            <button class="pagination-btn" id="searchPrevBtn" onclick="changeSearchPage(-1)">‚Üê Previous</button>
            <span class="pagination-info" id="searchPageInfo">Page 1 of 1</span>
            <button class="pagination-btn" id="searchNextBtn" onclick="changeSearchPage(1)">Next ‚Üí</button>
        </div>
        </div>
    </section>
        <!-- Categories 
        <section class="categories">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Shop by Category</h2>
                    <p class="section-subtitle">Find exactly what you need for your studies</p>
                </div>

                <div class="category-grid">
                    <div class="category-card" onclick="viewCategory('textbooks')">
                        <div class="category-icon">üìö</div>
                        <h3 class="category-title">Textbooks</h3>
                        <p class="category-description">Course materials, study guides, and reference books</p>
                    </div>

                    <div class="category-card" onclick="viewCategory('electronics')">
                        <div class="category-icon">üíª</div>
                        <h3 class="category-title">Electronics</h3>
                        <p class="category-description">Laptops, tablets, calculators, and accessories</p>
                    </div>

                    <div class="category-card" onclick="viewCategory('supplies')">
                        <div class="category-icon">‚úèÔ∏è</div>
                        <h3 class="category-title">Supplies</h3>
                        <p class="category-description">Notebooks, pens, backpacks, and study materials</p>
                    </div>

                    <div class="category-card" onclick="viewCategory('furniture')">
                        <div class="category-icon">ü™ë</div>
                        <h3 class="category-title">Dorm Furniture</h3>
                        <p class="category-description">Chairs, desks, storage, and room essentials</p>
                    </div>

                    <div class="category-card" onclick="viewCategory('clothing')">
                        <div class="category-icon">üëï</div>
                        <h3 class="category-title">Clothing</h3>
                        <p class="category-description">University merchandise, casual wear, and accessories</p>
                    </div>

                    <div class="category-card" onclick="viewCategory('other')">
                        <div class="category-icon">üéí</div>
                        <h3 class="category-title">Other</h3>
                        <p class="category-description">Sports equipment, art supplies, and miscellaneous</p>
                    </div>
                </div>
            </div>
        </section> -->

        <!-- Featured Products -->
        <section class="featured-products" id="featuredSection">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Featured Items</h2>
                    <p class="section-subtitle">Popular items from fellow students</p>
                </div>

                <div class="product-grid" id="featuredProductsGrid">
                    <!-- Loading state -->
                    <div class="loading-featured" id="featuredLoading">
                        <div class="loading-spinner"></div>
                        <p>Loading featured items...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="pagination-container" id="featuredPagination" style="display: none;">
                    <button class="pagination-btn" id="featuredPrevBtn" onclick="changeFeaturedPage(-1)">‚Üê Previous</button>
                    <span class="pagination-info" id="featuredPageInfo">Page 1 of 1</span>
                    <button class="pagination-btn" id="featuredNextBtn" onclick="changeFeaturedPage(1)">Next ‚Üí</button>
                </div>
            </div>
        </section>

        <!-- How It Works -->
        <section class="how-it-works">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">How It Works</h2>
                    <p class="section-subtitle">Simple steps to buy and sell on StudentHub</p>
                </div>

                <div class="steps-grid">
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <h3 class="step-title">Browse & Search</h3>
                        <p class="step-description">Find items you need using our search or browse by category</p>
                    </div>

                    <div class="step-card">
                        <div class="step-number">2</div>
                        <h3 class="step-title">Connect & Chat</h3>
                        <p class="step-description">Message sellers directly to ask questions or negotiate prices</p>
                    </div>

                    <div class="step-card">
                        <div class="step-number">3</div>
                        <h3 class="step-title">Meet & Exchange</h3>
                        <p class="step-description">Meet safely on campus to complete your transaction</p>
                    </div>

                    <div class="step-card">
                        <div class="step-number">4</div>
                        <h3 class="step-title">Rate & Review</h3>
                        <p class="step-description">Leave feedback to help build our trusted community</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>StudentHub</h3>
                    <ul>
                        <li><a href="./about.html">About Us</a></li>
                        <li><a href="#how-it-works" onclick="scrollToHowItWorks()">How It Works</a></li>
                        <li><a href="./safety-tips.html">Safety Tips</a></li>
                        <li><a href="mailto:i.t.kariboalalibo@edu.salford.ac.uk">Contact</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3>Categories</h3>
                    <ul>
                        <li><a href="#" onclick="searchCategory('textbooks'); return false;">üìö Textbooks</a></li>
                        <li><a href="#" onclick="searchCategory('electronics'); return false;">üíª Electronics</a></li>
                        <li><a href="#" onclick="searchCategory('supplies'); return false;">‚úèÔ∏è Supplies</a></li>
                        <li><a href="#" onclick="searchCategory('furniture'); return false;">ü™ë Furniture</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3>Account</h3>
                    <ul>
                        <li><a href="../index.html">Sign Up</a></li>
                        <li><a href="../index.html">Log In</a></li>
                        <li><a href="./profile.html">My Profile</a></li>
                        <li><a href="./sellItem.html">Sell Item</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3>Support</h3>
                    <ul>
                        <li><a href="mailto:i.t.kariboalalibo@edu.salford.ac.uk">Help & Support</a></li>
                        <li><a href="./privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="./terms.html">Terms of Service</a></li>
                        <li><a href="mailto:i.t.kariboalalibo@edu.salford.ac.uk?subject=StudentHub Issue Report">Report Issue</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 StudentHub. University of Salford Final Year Project by Israel Kariboalalibo.</p>
            </div>
        </footer>
        <script src="../cart.js"></script>
        <script src="../landing_page.js"></script>
        <script>
            // Category name mapping for display
            const categoryDisplayNames = {
                'textbooks': ' Textbooks',
                'electronics': ' Electronics',
                'supplies': ' Supplies',
                'furniture': 'Dorm Furniture',
                'clothing': 'Clothing',
                'other': 'Other'
            };

            document.addEventListener("DOMContentLoaded", async () => {
            // Check for URL search parameter (from mobile redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const urlSearch = urlParams.get('search');
            
            const savedResults = localStorage.getItem("searchResults");
            const savedQuery   = localStorage.getItem("searchQuery");
            const selectedItem = localStorage.getItem("selectedProduct");
            const categoryResults = localStorage.getItem("categoryResults");
            const selectedCategory = localStorage.getItem("selectedCategory");

            console.log(savedQuery);

            let products = [];
            let queryTerm = null;
            let isCategory = false;
            
            // Variables to persist in header after loading
            let persistSearchQuery = '';
            let persistCategory = '';
            let persistPriceFilter = localStorage.getItem("priceFilter") || '';

            try {
                // Check URL search parameter first (for mobile redirects)
                if (urlSearch) {
                    queryTerm = urlSearch;
                    persistSearchQuery = urlSearch;
                    const res = await fetch(`/search?query=${encodeURIComponent(urlSearch)}`);
                    products = await res.json();
                    console.log("URL search:", urlSearch, products.length, "items");
                    // Clean URL without reloading
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (categoryResults) {
                // Case: Category search
                products = JSON.parse(categoryResults);
                queryTerm = categoryDisplayNames[selectedCategory] || selectedCategory;
                persistCategory = selectedCategory;
                isCategory = true;
                console.log("Category search:", selectedCategory, products.length, "items");
                } else if (selectedItem) {
                // Case 1: user clicked one product
                const item = JSON.parse(selectedItem);
                products = [item];  // wrap in array for uniform rendering
                queryTerm = item.title || item.name;
                } else if (savedResults) {
                // Case 2: multiple results saved
                products = JSON.parse(savedResults);
                queryTerm = products.length ? products[0].title || products[0].name : "";
                persistSearchQuery = savedQuery || '';
                } else if (savedQuery) {
                // Case 3: user pressed Enter
                queryTerm = savedQuery;
                persistSearchQuery = savedQuery;
                const res = await fetch(`/search?query=${encodeURIComponent(savedQuery)}`);
                products = await res.json();
                }
            } catch (err) {
                console.error("Error parsing saved search:", err);
            }

            // Get price filter used for category search (if any)
            const categoryPriceFilter = localStorage.getItem("categoryPriceFilter");
            if (categoryPriceFilter) {
                persistPriceFilter = categoryPriceFilter;
            }

            // Clear storage so future reloads don't repeat
            localStorage.removeItem("searchResults");
            localStorage.removeItem("searchQuery");
            localStorage.removeItem("selectedProduct");
            
            // Save persisted values for header restoration
            if (persistSearchQuery) {
                localStorage.setItem("persistedSearchQuery", persistSearchQuery);
            } else {
                localStorage.removeItem("persistedSearchQuery");
            }
            
            if (persistCategory) {
                localStorage.setItem("persistedCategory", persistCategory);
            } else {
                localStorage.removeItem("persistedCategory");
            }
            
            if (persistPriceFilter) {
                localStorage.setItem("persistedPriceFilter", persistPriceFilter);
            } else {
                localStorage.removeItem("persistedPriceFilter");
            }
            
            // Restore values to header inputs after a short delay (to ensure header is loaded)
            setTimeout(() => {
                const searchInput = document.getElementById('liveSearchInput');
                const categoryFilter = document.getElementById('categoryFilter');
                const priceFilter = document.getElementById('priceFilter');
                
                if (searchInput && persistSearchQuery) {
                    searchInput.value = persistSearchQuery;
                }
                if (categoryFilter && persistCategory) {
                    categoryFilter.value = persistCategory;
                }
                if (priceFilter && persistPriceFilter) {
                    priceFilter.value = persistPriceFilter;
                }
            }, 100);
            localStorage.removeItem("categoryResults");
            localStorage.removeItem("selectedCategory");
            localStorage.removeItem("categoryPriceFilter");

            const featuredSection      = document.getElementById("featuredSection");
            const searchResultsSection = document.getElementById("searchResultsSection");
            const searchResultsGrid    = document.getElementById("searchResultsGrid");
            const sectionTitle         = searchResultsSection.querySelector(".section-title");
            const sectionSubtitle      = searchResultsSection.querySelector(".section-subtitle");

            // Price filter display names
            const priceFilterNames = {
                '0-25': 'Under ¬£25',
                '25-50': '¬£25 - ¬£50',
                '50-100': '¬£50 - ¬£100',
                '100-200': '¬£100 - ¬£200',
                '200+': '¬£200+'
            };

            // Update section title based on search type
            if (isCategory && sectionTitle && sectionSubtitle) {
                sectionTitle.textContent = queryTerm;
                if (categoryPriceFilter && priceFilterNames[categoryPriceFilter]) {
                    sectionSubtitle.textContent = `Filtered by: ${priceFilterNames[categoryPriceFilter]}`;
                } else {
                    sectionSubtitle.textContent = `Browse all items in this category`;
                }
            } else if (sectionTitle && sectionSubtitle) {
                sectionTitle.textContent = "Search Results";
                sectionSubtitle.textContent = `Here's what we found for your search`;
            }

            //check to see user has pressed enter to select multiple items or if user has clicked an item only from dropdown
            let shouldScrollToResults = false;
            
            if (urlSearch || isCategory || savedQuery){
                searchResultsSection.style.display = "block";
                featuredSection.style.display = "none";
                shouldScrollToResults = true;
                console.log("Showing search/category results");
            }
            else if (!savedResults){
                searchResultsSection.style.display = "none";
                featuredSection.style.display = "block";
                // Clear persisted filters when showing default view
                localStorage.removeItem("persistedSearchQuery");
                localStorage.removeItem("persistedCategory");
                localStorage.removeItem("persistedPriceFilter");
                localStorage.removeItem("priceFilter");
                console.log("from block 2");
            }
            else if (!selectedItem){
                searchResultsSection.style.display = "none";
                featuredSection.style.display = "block";
                // Clear persisted filters when showing default view
                localStorage.removeItem("persistedSearchQuery");
                localStorage.removeItem("persistedCategory");
                localStorage.removeItem("persistedPriceFilter");
                localStorage.removeItem("priceFilter");
                console.log("from block 3");
            }else{
                featuredSection.style.display = "none";
                searchResultsSection.style.display = "block";
                shouldScrollToResults = true;
                console.log("from block 4");
            }
            
            // Scroll to search results section after a short delay
            if (shouldScrollToResults) {
                setTimeout(() => {
                    searchResultsSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 150);
            }
            

            // Load featured products if showing featured section (must happen before early returns)
            if (featuredSection.style.display !== 'none') {
                loadFeaturedProducts();
            }

            if (!products.length && (isCategory || savedQuery || savedResults || selectedItem)) {
                searchResultsGrid.innerHTML = `
                <div class="no-results-anim">
                    <div class="emoji">${isCategory ? 'üì¶' : 'üîç'}</div>
                    <p>No items found ${isCategory ? 'in' : 'for'} "<strong>${queryTerm || "your search"}</strong>"</p>
                </div>`;
                if (window.gsap) gsap.from(".no-results-anim",{opacity:0,y:20,duration:0.6});
                return;
            }
            
            if (!products.length) return;

            // Store all products for pagination
            allSearchProducts = products;
            window.searchProducts = products;
            
            // Calculate pagination
            searchTotalPages = Math.ceil(products.length / ITEMS_PER_PAGE);
            searchCurrentPage = 1;
            
            // Render first page
            renderSearchPage();
            
            // Show/hide pagination
            const searchPagination = document.getElementById('searchPagination');
            if (searchTotalPages > 1) {
                searchPagination.style.display = 'flex';
                updateSearchPaginationUI();
            } else {
                searchPagination.style.display = 'none';
            }

            // Adjust grid layout if only one item
            if (products.length === 1) {
            searchResultsGrid.classList.add("single-item");
            } else {
            searchResultsGrid.classList.remove("single-item");
            }
            });

            function sanitizeImageUrl(url){
            if(!url) return "../images/default-placeholder.png";
            if(url.startsWith("http")) return url;
            return `https://bfpaawywaljnfudynnke.supabase.co/storage/v1/object/public/${url}`;
            }
            function escapeHtml(str){
            return str ? str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : "";
            }

            function viewProductDetails(item) {
                localStorage.setItem("selectedItem", JSON.stringify(item));
                window.location.href = "productDetails.html";
            }

            // Pagination state
            const ITEMS_PER_PAGE = 8;
            let featuredCurrentPage = 1;
            let featuredTotalPages = 1;
            let allFeaturedProducts = [];
            
            let searchCurrentPage = 1;
            let searchTotalPages = 1;
            let allSearchProducts = [];

            // Load featured products from API
            async function loadFeaturedProducts() {
                const featuredGrid = document.getElementById('featuredProductsGrid');
                const paginationContainer = document.getElementById('featuredPagination');
                
                try {
                    // Fetch more products for pagination (up to 50)
                    const response = await fetch('/api/featured-products?limit=50');
                    if (!response.ok) throw new Error('Failed to fetch featured products');
                    
                    const products = await response.json();
                    
                    if (!products || products.length === 0) {
                        featuredGrid.innerHTML = `
                            <div class="no-results-anim" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                                <div class="emoji">üì¶</div>
                                <p>No featured products available yet</p>
                            </div>
                        `;
                        paginationContainer.style.display = 'none';
                        return;
                    }
                    
                    // Store all products
                    allFeaturedProducts = products;
                    window.featuredProducts = products;
                    
                    // Calculate pagination
                    featuredTotalPages = Math.ceil(products.length / ITEMS_PER_PAGE);
                    featuredCurrentPage = 1;
                    
                    // Render first page
                    renderFeaturedPage();
                    
                    // Show/hide pagination
                    if (featuredTotalPages > 1) {
                        paginationContainer.style.display = 'flex';
                        updateFeaturedPaginationUI();
                    } else {
                        paginationContainer.style.display = 'none';
                    }
                    
                } catch (err) {
                    console.error('Error loading featured products:', err);
                    featuredGrid.innerHTML = `
                        <div class="no-results-anim" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                            <div class="emoji">‚ö†Ô∏è</div>
                            <p>Error loading featured products</p>
                            <button class="btn btn-primary btn-sm" onclick="loadFeaturedProducts()">Try Again</button>
                        </div>
                    `;
                }
            }
            
            function renderFeaturedPage() {
                const featuredGrid = document.getElementById('featuredProductsGrid');
                const startIndex = (featuredCurrentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const pageProducts = allFeaturedProducts.slice(startIndex, endIndex);
                
                featuredGrid.innerHTML = pageProducts.map((item, index) => {
                    const globalIndex = startIndex + index;
                    return `
                        <div class="product-card featured-card" data-featured-index="${globalIndex}">
                            <div class="product-image-container">
                                <img src="${sanitizeImageUrl(item.image_url)}"
                                    alt="${escapeHtml(item.title)}"
                                    onerror="this.src='../images/default-placeholder.png';"
                                    class="product-image">
                                ${item.review_count > 0 ? `<span class="review-badge">‚≠ê ${item.review_count} review${item.review_count > 1 ? 's' : ''}</span>` : ''}
                            </div>
                            <div class="product-info">
                                <span class="product-category">${escapeHtml(item.category || 'Other')}</span>
                                <h3 class="product-title">${escapeHtml(item.title)}</h3>
                                <div class="product-price">¬£${parseFloat(item.price).toFixed(2)}</div>
                                <span class="product-condition">${escapeHtml(item.condition || 'Good')}</span>
                                <div class="product-seller">Sold by ${escapeHtml(item.seller_name || 'Student')}</div>
                                <div class="product-actions">
                                    <button class="btn btn-primary btn-sm featured-add-cart" data-featured-index="${globalIndex}">Add to Cart</button>
                                    <button class="btn btn-outline btn-sm featured-contact" data-featured-index="${globalIndex}">Contact</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Attach click handlers
                attachFeaturedClickHandlers();
            }
            
            function changeFeaturedPage(direction) {
                const newPage = featuredCurrentPage + direction;
                if (newPage >= 1 && newPage <= featuredTotalPages) {
                    featuredCurrentPage = newPage;
                    renderFeaturedPage();
                    updateFeaturedPaginationUI();
                    // Scroll to top of featured section
                    document.getElementById('featuredSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            
            function updateFeaturedPaginationUI() {
                document.getElementById('featuredPageInfo').textContent = `Page ${featuredCurrentPage} of ${featuredTotalPages}`;
                document.getElementById('featuredPrevBtn').disabled = featuredCurrentPage === 1;
                document.getElementById('featuredNextBtn').disabled = featuredCurrentPage === featuredTotalPages;
            }
            
            // Make pagination functions global
            window.changeFeaturedPage = changeFeaturedPage;
            
            // Search Results Pagination Functions
            function renderSearchPage() {
                const searchResultsGrid = document.getElementById('searchResultsGrid');
                const startIndex = (searchCurrentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const pageProducts = allSearchProducts.slice(startIndex, endIndex);
                
                searchResultsGrid.innerHTML = pageProducts.map((item, index) => {
                    const globalIndex = startIndex + index;
                    return `
                        <div class="product-card" data-product-index="${globalIndex}">
                            <img src="${sanitizeImageUrl(item.image_url)}"
                                alt="${escapeHtml(item.title || item.name)}"
                                onerror="this.src='../images/default-placeholder.png';"
                                style="width:100%;height:200px;object-fit:cover;border-top-left-radius:20px;border-top-right-radius:20px;">
                            <div class="product-info">
                                <h3 class="product-title">${escapeHtml(item.title || item.name)}</h3>
                                <div class="product-price">¬£${parseFloat(item.price || 0).toFixed(2)}</div>
                                <span class="product-condition">${item.condition || "Good"}</span>
                                <div class="product-seller">Sold by ${item.seller_name || item.seller || item.first_name || "Student"}</div>
                                <div class="product-actions">
                                    <button class="btn btn-primary btn-sm add-to-cart-btn" data-product-index="${globalIndex}">Add to Cart</button>
                                    <button class="btn btn-outline btn-sm contact-btn" data-product-index="${globalIndex}">Contact</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Attach click handlers
                attachSearchClickHandlers();
            }
            
            function attachSearchClickHandlers() {
                // Card click - navigate to product details
                document.querySelectorAll('#searchResultsGrid .product-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.add-to-cart-btn') || e.target.closest('.contact-btn')) {
                            return;
                        }
                        const index = parseInt(card.dataset.productIndex);
                        const item = window.searchProducts[index];
                        if (item) viewProductDetails(item);
                    });
                });

                // Add to Cart buttons
                document.querySelectorAll('#searchResultsGrid .add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.dataset.productIndex);
                        const item = window.searchProducts[index];
                        if (item && window.Cart) {
                            Cart.addItem(item);
                        }
                    });
                });

                // Contact buttons
                document.querySelectorAll('#searchResultsGrid .contact-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.dataset.productIndex);
                        const item = window.searchProducts[index];
                        if (item && item.seller_id) {
                            window.location.href = `messages.html?seller=${item.seller_id}&product=${item.product_id}`;
                        } else {
                            alert('Unable to contact seller. Please try again.');
                        }
                    });
                });
            }
            
            function changeSearchPage(direction) {
                const newPage = searchCurrentPage + direction;
                if (newPage >= 1 && newPage <= searchTotalPages) {
                    searchCurrentPage = newPage;
                    renderSearchPage();
                    updateSearchPaginationUI();
                    // Scroll to top of search results
                    document.getElementById('searchResultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            
            function updateSearchPaginationUI() {
                document.getElementById('searchPageInfo').textContent = `Page ${searchCurrentPage} of ${searchTotalPages}`;
                document.getElementById('searchPrevBtn').disabled = searchCurrentPage === 1;
                document.getElementById('searchNextBtn').disabled = searchCurrentPage === searchTotalPages;
            }
            
            // Make search pagination function global
            window.changeSearchPage = changeSearchPage;
            
            function attachFeaturedClickHandlers() {
                // Card click - navigate to product details
                document.querySelectorAll('.featured-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.featured-add-cart') || e.target.closest('.featured-contact')) {
                            return;
                        }
                        const index = parseInt(card.dataset.featuredIndex);
                        const product = window.featuredProducts[index];
                        if (product) viewProductDetails(product);
                    });
                });

                // Add to Cart buttons
                document.querySelectorAll('.featured-add-cart').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.dataset.featuredIndex);
                        const product = window.featuredProducts[index];
                        if (product && window.Cart) {
                            Cart.addItem(product);
                        }
                    });
                });

                // Contact buttons
                document.querySelectorAll('.featured-contact').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(btn.dataset.featuredIndex);
                        const product = window.featuredProducts[index];
                        if (product && product.seller_id) {
                            // Navigate to messages with seller
                            window.location.href = `messages.html?seller=${product.seller_id}&product=${product.product_id}`;
                        } else {
                            alert('Unable to contact seller. Please try again.');
                        }
                    });
                });
            }

            // Footer helper functions
            function scrollToHowItWorks() {
                const section = document.querySelector('.how-it-works');
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            async function searchCategory(category) {
                try {
                    const response = await fetch(`/api/category/${category}`);
                    if (response.ok) {
                        const products = await response.json();
                        localStorage.setItem('categoryResults', JSON.stringify(products));
                        localStorage.setItem('selectedCategory', category);
                        window.location.reload();
                    }
                } catch (err) {
                    console.error('Category search error:', err);
                }
            }

        </script>
    </body>
</html>      


